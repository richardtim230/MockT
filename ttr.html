<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ffmpeg.wasm MP4 Export DEMO</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.9/dist/ffmpeg.min.js"></script>
  <style>
    .css-loader{border-top-color:#6366f1;animation:spin 1s linear infinite;}
    @keyframes spin {to {transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-slate-100 text-slate-900 p-6">
  <h1 class="text-xl font-bold mb-5">ffmpeg.wasm Video Export Test</h1>
  <button id="render-btn" class="bg-indigo-600 text-white px-5 py-2 rounded font-semibold mb-6">Export MP4</button>
  <div id="render-spinner" class="mb-6 hidden"><div class="w-8 h-8 border-4 border-indigo-300 rounded-full css-loader"></div></div>
  <div id="log" class="font-mono bg-slate-200 text-xs rounded mb-4 p-2 max-w-2xl"></div>
  <video id="rendered-video" controls class="bg-black rounded shadow max-w-lg w-full"></video>
  <a id="download-link" download="sample.mp4" class="bg-indigo-700 text-white px-4 py-2 rounded mt-3 inline-block" href="#" style="display:none">Download Video</a>
  <script>
    // Demo: create 3 colored "slides" as PNGs
    function makeSlides() {
      let slides = [], colors = ["#64748b", "#818cf8", "#e879f9"], lines = ["Hello World!", "ffmpeg.wasm export", "Line #3"];
      const c = document.createElement('canvas'); c.width=800; c.height=800;
      const ctx = c.getContext('2d');
      for(let i=0; i<3; ++i) {
        ctx.fillStyle = colors[i]; ctx.fillRect(0,0,800,800);
        ctx.font = "bold 58px sans-serif";
        ctx.textAlign = "center"; ctx.fillStyle="#fff";
        ctx.fillText(lines[i], 400, 430);
        slides.push(c.toDataURL("image/png"));
      }
      return slides;
    }
    function b64toArr(dataUrl){
      const bin = atob(dataUrl.split(',')[1]);
      const arr = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;++i) arr[i]=bin.charCodeAt(i);
      return arr;
    }
    // ffmpeg
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    document.getElementById('render-btn').onclick = async function() {
      this.disabled = true;
      document.getElementById('log').textContent = "Loading ffmpeg.wasm..."; 
      document.getElementById('render-spinner').classList.remove('hidden');
      try {
        if (!ffmpeg.isLoaded()) await ffmpeg.load();
        const slides = makeSlides();
        for (let i = 0; i < slides.length; ++i) {
          ffmpeg.FS('writeFile', `slide${i}.png`, b64toArr(slides[i]));
        }
        // Concat file
        let concatTxt = '';
        for (let i = 0; i<slides.length; ++i) {
          concatTxt += `file 'slide${i}.png'\nduration 2.5\n`;
        }
        concatTxt += `file 'slide${slides.length-1}.png'\n`; // ffmpeg needs last line repeated
        ffmpeg.FS('writeFile', 'input.txt', concatTxt);

        document.getElementById('log').textContent += "\nEncoding...";
        // Run ffmpeg
        await ffmpeg.run('-f','concat','-safe','0','-i','input.txt',
                         '-vf','format=yuv420p',
                         '-r','30','-c:v','libx264',
                         '-pix_fmt','yuv420p','-movflags','+faststart','out.mp4');
        const outBuf = ffmpeg.FS('readFile','out.mp4');
        const outUrl = URL.createObjectURL(new Blob([outBuf.buffer],{type:"video/mp4"}));
        document.getElementById('rendered-video').src = outUrl;
        document.getElementById('download-link').href = outUrl;
        document.getElementById('download-link').style.display = '';
        document.getElementById('log').textContent += "\nDone!";
      } catch(e) {
        document.getElementById('log').textContent += "\nERROR: " + e.message;
        alert("Video export failed:\n"+e.message);
      } finally {
        document.getElementById('render-btn').disabled = false;
        document.getElementById('render-spinner').classList.add('hidden');
      }
    };
  </script>
</body>
</html>
