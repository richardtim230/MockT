<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Registration Wizard - D-RICH TUTORIAL COLLEGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Flowbite CSS (for modals & UI consistency) -->
  <link href="https://cdn.jsdelivr.net/npm/flowbite@1.5.3/dist/flowbite.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif;}
    .glass { background: rgba(255,255,255,0.7);}
    .spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 32px; height: 32px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .avatar-preview {
      width: 96px; height: 96px; object-fit: cover;
      border-radius: 0.75rem;
      border: 2px solid #0ea5e9;
      margin: 0.5rem auto;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">

<div class="w-full max-w-xl glass rounded-lg shadow-lg p-8 m-4">
  <h2 class="text-2xl md:text-3xl font-bold text-center text-blue-900 mb-8">Student Registration</h2>
  <!-- Progress Steps -->
  <ol class="flex items-center justify-center mb-6 text-sm font-medium text-center text-gray-700 sm:text-base">
    <li class="mr-2" id="step-indicator-1">1. Basic Info</li>
    <li class="mr-2" id="step-indicator-2">2. Program</li>
    <li class="mr-2" id="step-indicator-3">3. Passport</li>
    <li id="step-indicator-4">4. Consent</li>
  </ol>

  <!-- Step-Wizard Form -->
  <form id="wizardForm" autocomplete="off">
    <!-- Step 1 -->
    <div class="step" id="step-1">
      <div>
        <label for="fullName" class="block font-semibold mb-1">Full Name <span class="text-red-600">*</span></label>
        <input type="text" id="fullName" name="fullName" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300" autocomplete="off">
        <span class="text-xs text-red-500 hidden" id="error-fullName">Full Name is required.</span>
      </div>
      <div class="mt-4">
        <label for="email" class="block font-semibold mb-1">Email <span class="text-red-600">*</span></label>
        <input type="email" id="email" name="email" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300">
        <span class="text-xs text-red-500 hidden" id="error-email">Valid email required.</span>
      </div>
      <div class="mt-4">
        <label for="phone" class="block font-semibold mb-1">Phone Number <span class="text-red-600">*</span></label>
        <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300" pattern="^\d{10,15}$" placeholder="Numbers only">
        <span class="text-xs text-red-500 hidden" id="error-phone">Valid phone number required.</span>
      </div>
      <div class="mt-4 flex space-x-4">
        <div class="flex-1">
          <label for="dob" class="block font-semibold mb-1">Date of Birth</label>
          <input type="date" id="dob" name="dob" class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300">
        </div>
        <div class="flex-1">
          <label for="gender" class="block font-semibold mb-1">Gender</label>
          <select id="gender" name="gender" class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300">
            <option value="">Choose</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <!-- Password field -->
      <div class="mt-4">
        <label for="password" class="block font-semibold mb-1">Password <span class="text-red-600">*</span></label>
        <div class="relative flex items-center">
          <input type="password" id="password" name="password"
                  required
                  class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300 pr-16"
                  autocomplete="new-password">
          <button type="button" tabindex="-1"
                  class="absolute right-2 flex items-center text-gray-400 hover:text-blue-700"
                  id="togglePassword">
            <svg id="eyeIcon" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
                 viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </button>
        </div>
        <span class="text-xs text-red-500 hidden" id="error-password">
          Password must be at least 8 characters, including a number and a letter.
        </span>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step hidden" id="step-2">
      <div>
        <label for="program" class="block font-semibold mb-1">Program Applying For <span class="text-red-600">*</span></label>
        <select id="program" name="program" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300">
          <option value="" disabled selected>Select a program</option>
          <option value="WAEC/NECO">WAEC/NECO</option>
          <option value="JAMB">JAMB</option>
          <option value="POST UTME">POST UTME</option>
        </select>
        <span class="text-xs text-red-500 hidden" id="error-program">Please select a program.</span>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step hidden" id="step-3">
      <div>
        <label for="passport" class="block font-semibold mb-1">Passport Photograph <span class="text-red-600">*</span></label>
        <input type="file" id="passport" name="passport" accept="image/*" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300">
        <span class="text-xs text-red-500 hidden" id="error-passport">Please upload a clear image.</span>
        <div id="passport-preview" class="mt-4 flex flex-col items-center"></div>
      </div>
    </div>

    <!-- Step 4 -->
    <div class="step hidden" id="step-4">
      <div>
        <label class="flex items-center">
          <input type="checkbox" id="terms" required class="mr-2">
          <span>I agree to the <a href="#" class="text-blue-600 underline">Terms & Conditions</a> and confirm my privacy.</span>
        </label>
        <span class="text-xs text-red-500 hidden" id="error-terms">You must agree before submitting.</span>
        <p class="text-xs mt-3 text-gray-500">Your data is kept private and used only for registration purposes.</p>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="mt-8 flex justify-between">
      <button type="button" id="backBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-6 py-2 rounded transition" disabled>Back</button>
      <button type="button" id="nextBtn" class="bg-blue-900 hover:bg-blue-800 text-white font-bold px-6 py-2 rounded transition">Next</button>
      <button type="submit" id="submitBtn" class="bg-green-700 hover:bg-green-600 text-white font-bold px-6 py-2 rounded transition hidden">Submit</button>
    </div>
  </form>
  <!-- Login redirect button -->
  <div class="mt-6 flex justify-center">
    <button type="button" id="loginBtn"
      class="border-2 border-blue-700 text-blue-700 rounded px-6 py-2 font-semibold hover:bg-blue-50 transition">
      Already have an account? Login
    </button>
  </div>
</div>

<!-- Modal Feedback -->
<div id="modal-feedback" class="hidden fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 text-center">
    <div id="modal-spinner" class="mb-4 spinner"></div>
    <div id="modal-message" class="text-lg font-semibold text-gray-700"></div>
    <button type="button" id="modal-close" class="mt-6 bg-blue-700 hover:bg-blue-600 text-white px-6 py-2 rounded transition">Close</button>
  </div>
</div>

<!-- Script: wizard, validation, password toggle, modal/redirect, passport preview, backend submit -->
<script>
const API_URL = "https://examguard-jmvj.onrender.com/api/student/register";
const form = document.getElementById('wizardForm');
const nextBtn = document.getElementById('nextBtn');
const backBtn = document.getElementById('backBtn');
const submitBtn = document.getElementById('submitBtn');
const loginBtn = document.getElementById('loginBtn');
const steps = Array.from(document.querySelectorAll('.step'));
const stepIndicators = [
  document.getElementById('step-indicator-1'),
  document.getElementById('step-indicator-2'),
  document.getElementById('step-indicator-3'),
  document.getElementById('step-indicator-4')
];
let currentStep = 0;

// Show/hide password toggle
document.getElementById('togglePassword').onclick = function() {
  const pass = document.getElementById('password');
  const eye = document.getElementById('eyeIcon');
  if (pass.type === 'password') {
    pass.type = 'text';
    eye.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-5 0-9-4.5-9-7a9.013 9.013 0 013.075-5.775M15 12a3 3 0 01-6 0 3 3 0 016 0zm6 0a9 9 0 1[...]`;
  } else {
    pass.type = 'password';
    eye.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6 0a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
  }
};

// Passport Image Preview Crop Simulation
document.getElementById('passport').addEventListener('change', function(e) {
  const previewDiv = document.getElementById('passport-preview');
  previewDiv.innerHTML = '';
  const file = e.target.files[0];
  if (file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      previewDiv.innerHTML = `<img src="${evt.target.result}" alt="Passport Preview" class="avatar-preview" /><br>
      <button type="button" class="mt-2 bg-red-500 text-white px-2 py-1 rounded" onclick="document.getElementById('passport').value='';document.getElementById('passport-preview').innerHTML='';">Remove</button>
      <p class="text-xs text-gray-500 mt-2">For best results use a square clear passport photo.</p>`;
    };
    reader.readAsDataURL(file);
  }
});

// Step navigation
function showStep(index) {
  steps.forEach((stepDiv, i) => {
    stepDiv.classList.toggle('hidden', i !== index);
    // Step indicator highlight:
    stepIndicators[i].classList.toggle('font-bold', i === index);
    stepIndicators[i].classList.toggle('text-blue-600', i === index);
  });
  backBtn.disabled = index === 0;
  nextBtn.classList.toggle('hidden', index === steps.length-1);
  submitBtn.classList.toggle('hidden', index !== steps.length-1);
  currentStep = index;
}
showStep(currentStep);

nextBtn.onclick = function() {
  if (validateStep(currentStep)) {
    showStep(currentStep+1);
  }
};
backBtn.onclick = function() {
  showStep(currentStep-1);
};

loginBtn.onclick = function() {
  window.location.href = "login.html";
};

// Simple validations per step
function validateStep(step) {
  let valid = true;
  if (step === 0) {
    // Full Name
    const name = form.fullName.value.trim();
    const err = document.getElementById('error-fullName');
    if (!name) { err.classList.remove('hidden'); valid=false; }
    else { err.classList.add('hidden'); }
    // Email
    const mail = form.email.value;
    const errEmail = document.getElementById('error-email');
    if (!mail.match(/^[\w-.]+@[\w-]+\.[a-zA-Z]{2,}$/)) { errEmail.classList.remove('hidden'); valid=false; }
    else { errEmail.classList.add('hidden'); }
    // Phone
    const phone = form.phone.value;
    const errPhone = document.getElementById('error-phone');
    if (!phone.match(/^\d{10,15}$/)) { errPhone.classList.remove('hidden'); valid=false; }
    else { errPhone.classList.add('hidden'); }
    // Password
    const pass = form.password.value;
    const errPass = document.getElementById('error-password');
    if (!pass.match(/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/)) {
      errPass.classList.remove('hidden');
      valid = false;
    } else {
      errPass.classList.add('hidden');
    }
  } else if (step === 1) {
    // Program
    const program = form.program.value;
    const errProgram = document.getElementById('error-program');
    if (!program) { errProgram.classList.remove('hidden'); valid=false;}
    else { errProgram.classList.add('hidden');}
  } else if (step === 2) {
    // Passport
    const passimg = form.passport.files[0];
    const errPass = document.getElementById('error-passport');
    if (!passimg || !passimg.type.startsWith('image/')) { errPass.classList.remove('hidden'); valid=false;}
    else { errPass.classList.add('hidden');}
  } else if (step === 3) {
    // Terms
    const terms = form.terms.checked;
    const errTerms = document.getElementById('error-terms');
    if (!terms) { errTerms.classList.remove('hidden'); valid=false;}
    else { errTerms.classList.add('hidden');}
  }
  return valid;
}

// Feedback Modal logic
function showModal(msg, loading=true) {
  document.getElementById('modal-message').innerHTML = msg;
  document.getElementById('modal-feedback').classList.remove('hidden');
  document.getElementById('modal-spinner').style.display = loading ? 'block' : 'none';
  document.getElementById('modal-close').style.display = loading ? 'none' : 'inline-block';
}
function hideModal() {
  document.getElementById('modal-feedback').classList.add('hidden');
}

// --- CHANGE: Modal close btn handles differently success/failure ---
let registrationWasSuccessful = false;
document.getElementById('modal-close').onclick = function() {
  hideModal();
  if (registrationWasSuccessful) {
    window.location.href = "login.html";
  } else {
    showStep(0);
    // Do NOT reset the form in failure; keep data as it is.
    // But if user uploaded failed passport image, also keep the selection/prefill (handled by browser)
    // Also: Modal/step validation UI resets are handled on step-1 showing.
  }
};

// --- MAIN CHANGE: submit backend logic ---
form.onsubmit = async function(e) {
  e.preventDefault();
  if (!validateStep(3)) return;
  showModal('Submitting your registration. Please wait...', true);

  // Prepare FormData for multipart/form-data request
  const formData = new FormData();
  formData.append("fullName", form.fullName.value.trim());
  formData.append("email", form.email.value.trim());
  formData.append("phone", form.phone.value.trim());
  formData.append("dob", form.dob.value || "");
  formData.append("gender", form.gender.value || "");
  // could add address, referral, guardianName, guardianPhone as blank for now
  formData.append("address", "");
  formData.append("program", form.program.value);
  formData.append("password", form.password.value);
  formData.append("referral", "");
  formData.append("guardianName", "");
  formData.append("guardianPhone", "");
  if (form.passport.files.length > 0) {
    formData.append("passport", form.passport.files[0]);
  }

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: formData
    });

    let result;
    try {
      result = await res.json();
    } catch (err) {
      result = {};
    }

    if (res.ok && result.message && result.message.toLowerCase().includes("success")) {
      registrationWasSuccessful = true;
      showModal('<span class="text-green-600">✔️ Registration successful!</span><br>Redirecting to login page...', false);
      form.reset();
      document.getElementById('passport-preview').innerHTML = '';
      showStep(0);
      setTimeout(() => {
        hideModal();
        window.location.href = "login.html";
      }, 2000);
    } else {
      registrationWasSuccessful = false;
      let msg = result && result.message
        ? `<span class="text-red-600">❌ ${result.message}</span>`
        : "<span class='text-red-600'>❌ Registration failed. Try again.</span>";
      showModal(msg, false);
      // Do NOT redirect to login; after OK, return to step 1 and allow user to retry, keeping form data
      // (see modal-close handling above)
    }
  } catch (err) {
    registrationWasSuccessful = false;
    showModal("<span class='text-red-600'>❌ Network error. Please try again later.</span>", false);
    // Do NOT redirect to login
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/flowbite@1.5.3/dist/flowbite.min.js"></script>
</body>
</html>
