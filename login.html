<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - D-RICH TUTORIAL COLLEGE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Flowbite CSS (for consistent UI) -->
  <link href="https://cdn.jsdelivr.net/npm/flowbite@1.5.3/dist/flowbite.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255, 0.76);}
    .spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 32px; height: 32px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    /* Modal buttons */
    .action-btn {
      @apply bg-blue-700 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold transition;
      margin: 0 0.5em;
    }
    .action-btn-orange {
      @apply bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded font-bold transition;
      margin: 0 0.5em;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">

<div class="w-full max-w-md glass rounded-lg shadow-lg p-8 m-4">
  <h2 class="text-2xl md:text-3xl font-bold text-center text-blue-900 mb-8">Login</h2>
  <form id="loginForm" autocomplete="off">
    <div>
      <label for="userKey" class="block font-semibold mb-1">Email or Phone</label>
      <input type="text" id="userKey" name="userKey" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300" autocomplete="username">
      <span class="text-xs text-red-500 hidden" id="error-userKey">Please enter your email or phone.</span>
    </div>
    <div class="mt-4">
      <label for="password" class="block font-semibold mb-1">Password</label>
      <div class="relative flex items-center">
        <input type="password" id="password" name="password" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-300 pr-12" autocomplete="current-password">
        <button type="button" tabindex="-1"
                class="absolute right-2 flex items-center text-gray-400 hover:text-blue-700"
                id="togglePassword">
          <svg id="eyeIcon" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
               viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </button>
      </div>
      <span class="text-xs text-red-500 hidden" id="error-password">Password is required.</span>
    </div>
    <div class="mt-8 flex justify-center">
      <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white font-bold px-8 py-2 rounded transition">
        Login
      </button>
    </div>
    <div class="mt-4 flex justify-center">
      <a href="registration.html" class="text-blue-700 underline text-sm hover:text-blue-900 transition">
        Don't have an account? Register
      </a>
    </div>
  </form>
</div>

<!-- Modal Feedback -->
<div id="modal-feedback" class="hidden fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8 text-center">
    <div id="modal-spinner" class="mb-4 spinner"></div>
    <div id="modal-message" class="text-lg font-semibold text-gray-700"></div>
    <div id="modal-actions" class="flex justify-center gap-4 mt-5"></div>
    <button type="button" id="modal-close" class="mt-6 bg-blue-700 hover:bg-blue-600 text-white px-6 py-2 rounded transition hidden">Close</button>
  </div>
</div>

<script>
const API_URL = "https://examguard-jmvj.onrender.com/api/student/login";

// Password visibility toggle
document.getElementById('togglePassword').onclick = function() {
  const pass = document.getElementById('password');
  const eye = document.getElementById('eyeIcon');
  if (pass.type === 'password') {
    pass.type = 'text';
    eye.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-5 0-9-4.5-9-7a9.013 9.013 0 013.075-5.775M15 12a3 3 0 01-6 0 3 3 0 016 0zm6 0a9 9 0 1[...]
  } else {
    pass.type = 'password';
    eye.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zm6 0a9 9 0 11-18 0 9 9 0 0118 0z"/>`;
  }
};

function showModal(msg, loading=true, actions=[]) {
  document.getElementById('modal-message').innerHTML = msg;
  document.getElementById('modal-feedback').classList.remove('hidden');
  document.getElementById('modal-spinner').style.display = loading ? 'block' : 'none';
  document.getElementById('modal-close').style.display = (loading || actions.length > 0) ? 'none' : 'inline-block';
  // Custom actions (for dashboard/CBT choice)
  const modalActionsDiv = document.getElementById('modal-actions');
  modalActionsDiv.innerHTML = '';
  if (actions.length > 0) {
    actions.forEach(({ label, callback, style }) => {
      const btn = document.createElement('button');
      btn.textContent = label;
      btn.className = style ? style : "action-btn";
      btn.onclick = () => {
        hideModal();
        callback();
      };
      modalActionsDiv.appendChild(btn);
    });
    modalActionsDiv.style.display = "flex";
  } else {
    modalActionsDiv.style.display = "none";
  }
}
function hideModal() {
  document.getElementById('modal-feedback').classList.add('hidden');
}
document.getElementById('modal-close').onclick = function() {
  hideModal();
};

document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  let valid = true;
  const userKey = document.getElementById('userKey').value.trim();
  const pass = document.getElementById('password').value.trim();
  const errUser = document.getElementById('error-userKey');
  const errPass = document.getElementById('error-password');
  if (!userKey) {
    errUser.classList.remove('hidden'); valid = false;
  } else { errUser.classList.add('hidden'); }
  if (!pass) {
    errPass.classList.remove('hidden'); valid = false;
  } else { errPass.classList.add('hidden'); }
  if (!valid) return;
  showModal('Authenticating, please wait...', true);

  // API
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ emailOrPhone: userKey, password: pass })
    });
    let result = {};
    try { result = await res.json(); } catch(e) {}
    if (res.ok && result.user && result.token) {
      // Save token (optionally, use sessionStorage/localStorage)
      localStorage.setItem("jwt_token", result.token);
      localStorage.setItem("user_role", result.user.role);

      // Ask user where to proceed:
      showModal(
        `
        <span class="text-green-600">✔️ Login successful!</span><br>
        <span class="block my-2 text-base text-gray-700">Proceed to Dashboard or CBT Exam?</span>
        `,
        false,
        [
          {
            label: "Go to Dashboard",
            style: "action-btn",
            callback: () => {
              let role = (result.user.role || "").toLowerCase();
              let redirectUrl = "index.html";
              if (role === "admin" || role === "superadmin") redirectUrl = "admin-dashboard.html";
              else if (role === "tutor") redirectUrl = "tutor-dashboard.html";
              else if (role === "student") redirectUrl = "dashboard.html";
              window.location.href = redirectUrl;
            }
          },
          {
            label: "CBT Login",
            style: "action-btn-orange",
            callback: () => {
              window.location.href = "cbt-login"; // or "cbt-login.html" as needed
            }
          }
        ]
      );
    } else {
      showModal(result.message
        ? `<span class="text-red-600">❌ ${result.message}</span>`
        : "<span class='text-red-600'>❌ Login failed. Try again.</span>", false);
    }
  } catch (e) {
    showModal("<span class='text-red-600'>❌ Network error. Please try again later.</span>", false);
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/flowbite@1.5.3/dist/flowbite.min.js"></script>
</body>
</html>
