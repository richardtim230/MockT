<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D-RICH Tutorial – Recharge Credit Points</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body { font-family: 'Inter', Arial, sans-serif; }
    .bg-corner {
      position: fixed;
      z-index: 0;
      pointer-events: none;
    }
    .glass-panel {
      background: rgba(255,255,255,0.93);
      backdrop-filter: blur(6px) saturate(120%);
      box-shadow: 0 6px 48px 0 rgba(99,101,241,.13);
      border-radius: 2rem;
      border: 1.5px solid rgba(99,102,241, 0.12);
    }
    .input-focus:focus { border-color: #6366f1; box-shadow: 0 0 0 1.5px #6366f1; }
    .spinner {display:inline-block;width:1.25em;height:1.25em;border:3px solid #fff;border-radius:50%;border-top:3px solid #2563eb;animation:spin 0.8s linear infinite;vertical-align:-0.25em;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center px-2 relative">
  
  <!-- Decorative Background Circles -->
  <div class="bg-corner left-0 top-0">
    <div class="w-32 h-32 bg-blue-200 rounded-full blur-2xl opacity-60 absolute -top-16 -left-12"></div>
    <div class="w-20 h-20 bg-indigo-200 rounded-full blur-xl opacity-60 absolute top-28 left-4"></div>
  </div>
  <div class="bg-corner right-0 bottom-0">
    <div class="w-40 h-40 bg-indigo-300 rounded-full blur-3xl opacity-80 absolute -bottom-24 -right-12"></div>
    <div class="w-24 h-24 bg-blue-100 rounded-full blur-xl opacity-70 absolute bottom-36 right-2"></div>
  </div>

  <main class="relative z-10 w-full max-w-lg mx-auto my-8 glass-panel p-8 sm:p-12">
    <div class="flex flex-col items-center mb-8">
      <i class="fas fa-coins text-yellow-400 text-5xl mb-2 drop-shadow"></i>
      <div class="text-xl sm:text-2xl font-extrabold text-blue-800 tracking-tight mb-1">Recharge Credit Points</div>
      <div class="text-base text-blue-400 font-semibold">D-RICH Tutorial Student Portal</div>
    </div>
    <div id="info-user" class="mb-5 flex flex-col items-center text-sm sm:text-base">
      <div>Logged in as <span class="font-bold text-gray-900" id="displayName"></span></div>
      <div class="pt-1 text-indigo-700">Current Credit Points: <span class="font-bold" id="currentCredit">—</span></div>
    </div>
    <form id="recharge-form" class="space-y-7 mt-2">
      <div>
        <label for="creditCode" class="block text-base font-semibold text-gray-700 mb-2">Enter Credit Recharge Code</label>
        <input
          type="text"
          maxlength="12"
          minlength="12"
          id="creditCode"
          name="creditCode"
          pattern="[0-9A-Za-z]{12}"
          class="input-focus block w-full px-5 py-3 rounded-xl border border-gray-300 focus:outline-none transition text-lg tracking-widest uppercase text-center font-mono"
          placeholder="e.g. 7GF39X2LQW4C"
          required
          autocomplete="off"
        />
      </div>
      <div>
        <button type="submit" id="recharge-btn"
          class="w-full py-3 px-8 rounded-xl bg-gradient-to-r from-yellow-400 to-orange-400 hover:from-yellow-500 hover:to-orange-500 text-gray-900 font-bold shadow-lg text-xl transition flex items-center justify-center gap-x-2">
          <i class="fa fa-bolt mr-2 text-[1.3em]"></i> <span>Redeem Credit</span>
        </button>
      </div>
      <div id="msg-info" class="pt-1 text-center text-base font-semibold hidden"></div>
    </form>
    <div class="mt-8 text-center text-sm text-gray-500">
      If you don’t have a code, contact admin through WhatsApp.<br>
      <a href="https://wa.me/2349155127634?text=Hello%2C%20I%20want%20to%20purchase%20CBT%20credit%20points%20on%20D-RICH%20Tutorial." 
         target="_blank" class="inline-flex items-center gap-1 px-4 py-2 rounded-full bg-green-700 text-white font-semibold mt-3 hover:bg-green-800 transition">
        <i class="fab fa-whatsapp text-lg"></i> WhatsApp Admin
      </a>
    </div>
  </main>
  <!-- Modal for success/error -->
  <div id="modal-root"></div>
  <script>
    const API_BASE = "/api/credit";
    // Util
    function getToken() { return localStorage.getItem("student_jwt_token"); }
    function setBtnSpinner(btn, show, text = "") {
      if (show) {
        btn.disabled = true;
        btn._realText = btn.querySelector('span')?.textContent;
        btn.querySelector('span').innerHTML = `<span class="mr-2 spinner"></span> ${text || "Processing..."}`;
      } else {
        btn.disabled = false;
        if (btn._realText) btn.querySelector('span').textContent = btn._realText;
      }
    }
    // Modal util
    function showModal({title, icon="info-circle", iconColor="indigo-500", message, cta, ctaHref}) {
      const root = document.getElementById('modal-root');
      root.innerHTML = `
        <div class="modal-bg">
          <div class="modal-panel">
            <div class="flex flex-col items-center space-y-2">
              <i class="fa fa-${icon} text-${iconColor} text-5xl mb-2"></i>
              <div class="text-xl font-extrabold text-indigo-900 mb-1">${title || "Notice"}</div>
              <div class="text-base text-gray-700 mb-2">${message}</div>
              ${cta ? `<a href="${ctaHref}" target="_blank" rel="noopener"
                class="mt-2 w-full flex items-center justify-center gap-2 py-3 px-6 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 transition-all text-lg">
                <i class="fab fa-whatsapp text-xl"></i>
                ${cta}
                </a>` : ""}
              <button id="modal-close-btn"
                class="mt-3 py-2 px-7 bg-blue-700 text-white font-semibold rounded-xl hover:bg-blue-900 shadow-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>`;
      document.getElementById('modal-close-btn').onclick = () => root.innerHTML = '';
    }
    // Fetch user info on load
    let currentUser = null;
    async function fetchProfile() {
      try {
        const res = await fetch("/api/student/me", {
          headers: { Authorization: "Bearer " + getToken() }
        });
        if (!res.ok) throw new Error("Not authenticated");
        return await res.json();
      } catch (err) { return null; }
    }
    async function showUserProfile(){
      const user = await fetchProfile();
      if(!user || !user._id){
        showModal({
          title:"Login Required",
          icon:"exclamation-triangle",
          iconColor:"red-600",
          message:"You must be logged in to recharge credits.",
        });
        setTimeout(()=>location.href='login.html',1300);
        return;
      }
      currentUser = user;
      document.getElementById('displayName').textContent = user.fullName;
      document.getElementById('currentCredit').textContent = user.creditPoints ?? "—";
    }
    showUserProfile();

    // Form handler
    document.getElementById('recharge-form').onsubmit = async function(e) {
      e.preventDefault();
      const btn = document.getElementById('recharge-btn');
      const codeInput = document.getElementById('creditCode');
      const msgDiv = document.getElementById('msg-info');
      let code = codeInput.value.trim().toUpperCase();
      msgDiv.classList.add('hidden');
      msgDiv.textContent = '';
      if(!/^[0-9A-Za-z]{12}$/.test(code)) {
        msgDiv.textContent = "Invalid code format. 12 alphanumeric only.";
        msgDiv.className="pt-1 text-center text-base font-semibold text-red-600 block";
        return;
      }
      setBtnSpinner(btn, true, "Verifying...");
      try {
        const res = await fetch(`${API_BASE}/redeem-credit`, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            Authorization: "Bearer " + getToken(),
          },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        setBtnSpinner(btn, false);
        if(res.ok && data.success) {
          showModal({
            title: "Recharge Successful!",
            icon: "check-circle",
            iconColor: "green-500",
            message: `You have been credited with <b>${data.points} points</b>.<br>Your new balance is <b>${data.creditPoints}</b> points.`,
          });
          document.getElementById('currentCredit').textContent = data.creditPoints;
          codeInput.value = "";
        } else {
          showModal({
            title: "Recharge Failed",
            icon: "times-circle",
            iconColor: "red-500",
            message: data.message || "Invalid or already used recharge code. Please check and try again.",
            cta: "Get New Code from Admin",
            ctaHref: "https://wa.me/2349155127634?text=Hello%2C%20I%20want%20to%20purchase%20CBT%20credit%20points%20on%20D-RICH%20Tutorial."
          });
        }
      } catch(err) {
        setBtnSpinner(btn,false);
        showModal({
          title: "Network Error",
          icon: "wifi",
          iconColor: "yellow-500",
          message: "Unable to connect. Check your network and try again."
        });
      }
    }
  </script>
</body>
</html>
